<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pague Leve — Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Meta Pixel (750766562712140) -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','750766562712140'); fbq('track','PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=750766562712140&ev=PageView&noscript=1"/>
  </noscript>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="w-full bg-amber-400 text-black">
    <div class="max-w-md md:max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="logo-pagueleve.png" alt="Pague Leve" class="h-6">
      </div>
      <div class="flex items-center gap-2 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 8V7a3 3 0 016 0v3H9z"/></svg>
        <span>Pagamento 100% seguro</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-[1fr_380px] gap-6 items-start">
      <!-- FORM (esquerda) -->
      <form id="checkout-form" class="space-y-4 bg-white p-5 rounded shadow-md">
        <input type="text" name="name" placeholder="Nome completo" class="w-full px-3 py-2 border rounded" required>
        <input type="email" name="email" placeholder="E-mail" class="w-full px-3 py-2 border rounded" required>
        <input type="text" name="cpf" placeholder="CPF (somente números)" class="w-full px-3 py-2 border rounded" required>

        <!-- Celular -->
        <input id="phone"
               name="phone"
               type="tel"
               inputmode="numeric"
               autocomplete="tel"
               maxlength="15"
               placeholder="(11) 91234-5678"
               class="w-full px-3 py-2 border rounded"
               required />

        <!-- Valor (automático) -->
        <input id="amount_brl" name="value" placeholder="Valor (R$)" class="w-full px-3 py-2 border rounded" readonly>
        <input type="hidden" id="total_cents" name="total_cents">

        <input type="text" name="coupon" placeholder="Cupom de desconto (%)" class="w-full px-3 py-2 border rounded">

        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">
          Pagar
        </button>
      </form>

      <!-- RESUMO (direita) -->
      <aside class="md:sticky md:top-4">
        <section id="order-summary" class="bg-white p-5 rounded shadow-md hidden">
          <h3 class="text-base font-semibold mb-3">Resumo</h3>
          <div id="order-items" class="space-y-3"></div>

          <div class="mt-3 border-t pt-3 space-y-1 text-sm">
            <div class="flex justify-between"><span>Produtos</span><span id="sum-subtotal">—</span></div>
            <div class="flex justify-between"><span>Frete</span><span>R$ 0,00</span></div>
            <div class="flex justify-between font-semibold text-base">
              <span>Total</span><span id="sum-total">—</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              Para alterar a quantidade, volte ao carrinho.
            </p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <!-- Scripts -->
  <script>
    // =====================================================
    // Resumo lateral (itens)
    // =====================================================
    function brlFmt(cents){
      return (Number(cents||0)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }

    function b64urlToJson(b64url){
      if (!b64url) return [];
      const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
      const pad = '='.repeat((4 - (b64.length % 4)) % 4);
      const str = atob(b64 + pad);
      try { return JSON.parse(decodeURIComponent(escape(str))); }
      catch { return JSON.parse(str); }
    }

    function parseItemsFromQS(){
      const p = new URLSearchParams(location.search);
      const b64 = p.get('items_b64');
      if (b64) return b64urlToJson(b64);
      const raw = p.get('items');
      if (raw){ try { return JSON.parse(decodeURIComponent(raw)); } catch { return []; } }
      return [];
    }

    function renderOrderSummary(){
      const items = parseItemsFromQS();
      const box   = document.getElementById('order-summary');
      const wrap  = document.getElementById('order-items');
      if (!box || !wrap) return;

      if (!items.length){ box.classList.add('hidden'); return; }

      let subtotal = 0;
      wrap.innerHTML = items.map((it)=>{
        const img = it.image
          ? `<img src="${it.image}" class="w-14 h-14 rounded object-cover" alt="">`
          : `<div class="w-14 h-14 rounded bg-gray-100"></div>`;
        const title   = it.title || 'Produto';
        const variant = (it.variant_title || it.variant)
          ? `<div class="text-xs text-gray-500 truncate">Var.: ${it.variant_title || it.variant}</div>` : '';
        const qty     = Math.max(1, Number(it.quantity ?? it.qty ?? 1));
        const price   = Math.max(0, Number(it.price_cents || 0));
        const line    = Number(it.line_price_cents ?? (price * qty));
        subtotal += line;

        return `
          <div class="flex items-center gap-3">
            ${img}
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">${title}</div>
              ${variant}
              <div class="text-xs text-gray-500 mt-1">${brlFmt(price)} un.</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="w-7 h-7 border rounded pointer-events-none opacity-60">–</button>
              <input value="${qty}" class="w-10 h-7 text-center border rounded pointer-events-none bg-gray-50" />
              <button type="button" class="w-7 h-7 border rounded pointer-events-none opacity-60">+</button>
            </div>
            <div class="w-24 text-right font-medium">${brlFmt(line)}</div>
          </div>
        `;
      }).join('');

      const subEl = document.getElementById('sum-subtotal');
      const totEl = document.getElementById('sum-total');
      if (subEl) subEl.textContent = brlFmt(subtotal);

      const enforcedTotal = (Number(document.getElementById('total_cents')?.value || 0) || 0);
      if (totEl) totEl.textContent = brlFmt(enforcedTotal || subtotal);

      box.classList.remove('hidden');
    }

    // Atualiza Total do resumo + inputs quando alguém chamar setTotalCents
    (function hookTotals(){
      const orig = window.setTotalCents;
      window.setTotalCents = function(cents){
        if (typeof orig === 'function') orig(cents);

        const centsNum = Number(cents || 0);

        const totalSpan = document.getElementById('sum-total');
        if (totalSpan) totalSpan.textContent = brlFmt(centsNum);

        const amountInput = document.getElementById('amount_brl');
        if (amountInput) amountInput.value = brlFmt(centsNum);

        const hidden = document.getElementById('total_cents');
        if (hidden) hidden.value = centsNum;
      };
    })();

    window.renderOrderSummary = renderOrderSummary;
    renderOrderSummary();

    // Define o valor inicial: URL ? total_cents : subtotal dos itens
    (function initAmount(){
      const amountInput = document.getElementById('amount_brl');
      const hidden = document.getElementById('total_cents');
      if (!amountInput || !hidden) return;

      const qs = new URLSearchParams(location.search);
      const tc = Number(qs.get('total_cents') || 0);

      function subtotalFromItems(){
        const items = (typeof parseItemsFromQS === 'function') ? parseItemsFromQS() : [];
        return items.reduce((acc, it) => {
          const qty   = Math.max(1, Number(it.quantity ?? it.qty ?? 1));
          const price = Math.max(0, Number(it.price_cents || 0));
          const line  = Number(it.line_price_cents ?? (price * qty));
          return acc + line;
        }, 0);
      }

      const cents = tc > 0 ? tc : subtotalFromItems();

      amountInput.value = brlFmt(cents);
      hidden.value = cents;

      if (typeof window.setTotalCents === 'function') window.setTotalCents(cents);
      console.log("checkout-ninja v2025-09-19");
    })();
  </script>

  <!-- Máscara de celular (única) -->
  <script>
  (function () {
    const el = document.getElementById('phone');
    if (!el) return;

    function format(raw) {
      // (DD) 99999-9999 progressivo
      const d = (raw || '').replace(/\D/g, '').slice(0, 11);
      let out = '';
      if (d.length > 0) out = '(' + d.slice(0, 2);
      if (d.length >= 3) out += ') ' + d.slice(2, Math.min(7, d.length));
      if (d.length >= 8) out += '-' + d.slice(7);
      return out;
    }

    el.addEventListener('input', function (e) {
      const start = e.target.selectionStart;
      const prev  = e.target.value;
      const raw   = prev.replace(/\D/g, '');
      const next  = format(raw);
      e.target.value = next;

      let pos = start;
      if (next[start - 1] === ')' && prev[start - 2] !== ')') pos++;
      if (next[start - 1] === '-' && prev[start - 2] !== '-') pos++;
      pos = Math.max(0, Math.min(next.length, pos));
      try { e.target.setSelectionRange(pos, pos); } catch (_) {}
    });

    // pré-formatar se vier valor
    el.value = format(el.value);
  })();
  </script>
</body>
</html>
