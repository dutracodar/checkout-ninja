<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cobrax Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <form id="checkout-form" class="bg-white p-8 rounded shadow-md w-full max-w-md space-y-4" autocomplete="off">
    <h2 class="text-2xl font-bold text-center">Cobrax Checkout</h2>

    <!-- hidden do carrinho -->
    <input id="cart_id" name="cart_id" type="hidden" />
    <input id="total_cents" name="total_cents" type="hidden" />

    <!-- DADOS PESSOAIS -->
    <input id="name" type="text" placeholder="Nome completo" required class="w-full px-4 py-2 border rounded"/>
    <input id="email" type="email" placeholder="E-mail" required class="w-full px-4 py-2 border rounded"/>
    <input id="cpf" type="text" inputmode="numeric" placeholder="CPF (somente números)" required class="w-full px-4 py-2 border rounded"/>
    <input id="phone" type="text" inputmode="numeric" placeholder="Celular (DDD+número)" required class="w-full px-4 py-2 border rounded"/>

    <!-- VALOR -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
      <input id="amount" type="text" value="10,00" placeholder="Ex.: 655,00 ou 655.00" required class="w-full px-4 py-2 border rounded"/>
    </div>

    <!-- CUPOM -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Cupom de desconto (%)</label>
      <div class="flex gap-2">
        <input id="coupon" type="text" placeholder="EXEMPLO" class="flex-1 px-4 py-2 border rounded"/>
        <input id="coupon_percent" type="number" min="0" max="100" step="1" placeholder="0" class="w-28 px-4 py-2 border rounded" />
        <button type="button" id="apply-coupon" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Aplicar</button>
      </div>
      <p id="coupon-status" class="text-xs text-gray-500 mt-1"></p>
    </div>

    <!-- ENDEREÇO DE ENTREGA -->
    <div class="space-y-2">
      <div class="font-semibold">Endereço de entrega</div>
      <div class="grid grid-cols-3 gap-2">
        <input id="cep" class="col-span-1 px-4 py-2 border rounded" inputmode="numeric" placeholder="CEP (00000-000)" required />
        <input id="state" class="col-span-1 px-4 py-2 border rounded" maxlength="2" placeholder="UF" required />
        <input id="city" class="col-span-1 px-4 py-2 border rounded" placeholder="Cidade" required />
      </div>
      <div id="cep-info" class="text-sm text-green-600 font-medium"></div>
      <input id="address1" class="w-full px-4 py-2 border rounded" placeholder="Rua / Avenida" required />
      <div class="grid grid-cols-3 gap-2">
        <input id="number" class="col-span-1 px-4 py-2 border rounded" placeholder="Número" required />
        <input id="neighborhood" class="col-span-1 px-4 py-2 border rounded" placeholder="Bairro" required />
        <input id="complement" class="col-span-1 px-4 py-2 border rounded" placeholder="Complemento" />
      </div>
      <p class="text-xs text-gray-500">Frete grátis. Endereço usado para nota fiscal e entrega.</p>
    </div>

    <!-- MÉTODO -->
    <div class="space-y-2">
      <label class="font-semibold block">Forma de pagamento</label>
      <div class="flex gap-4">
        <label class="flex items-center gap-2"><input type="radio" name="pmethod" value="pix" checked/>Pix</label>
        <label class="flex items-center gap-2"><input type="radio" name="pmethod" value="boleto"/>Boleto</label>
        <label class="flex items-center gap-2"><input type="radio" name="pmethod" value="card"/>Cartão</label>
      </div>
    </div>

    <!-- CAMPOS DO CARTÃO + PARCELAS -->
    <div id="card-fields" class="space-y-2 hidden">
      <input id="card_number" type="text" inputmode="numeric" maxlength="19" placeholder="0000 0000 0000 0000" class="w-full px-4 py-2 border rounded"/>
      <div class="grid grid-cols-3 gap-2">
        <input id="exp_month" type="text" inputmode="numeric" maxlength="2" placeholder="MM" class="w-full px-4 py-2 border rounded"/>
        <input id="exp_year" type="text" inputmode="numeric" maxlength="4" placeholder="AAAA" class="w-full px-4 py-2 border rounded"/>
        <input id="cvv" type="text" inputmode="numeric" maxlength="4" placeholder="CVV" class="w-full px-4 py-2 border rounded"/>
      </div>

      <!-- Parcelas -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Parcelas</label>
        <select id="installments" class="w-full px-4 py-2 border rounded"></select>
        <p class="text-xs text-gray-500 mt-1">
          * Valores aproximados. Parcelamento com <strong>juros do emissor</strong> (configurado na Pagar.me).
        </p>
      </div>
    </div>

    <div class="flex gap-2">
      <button id="pay-btn" type="submit" class="flex-1 bg-black text-white font-bold py-2 rounded hover:opacity-90">Pagar</button>
      <button id="confirm-btn" type="button" disabled class="w-36 bg-gray-200 text-gray-600 font-semibold py-2 rounded cursor-not-allowed">
        Já paguei
      </button>
    </div>

    <div id="status" class="text-center text-sm text-gray-700"></div>
    <div id="extra" class="mt-4 space-y-2 text-sm"></div>
  </form>

  <script>
    const form = document.getElementById('checkout-form');
    const statusEl = document.getElementById('status');
    const extraEl  = document.getElementById('extra');
    const cardBox  = document.getElementById('card-fields');
    const btnPay   = document.getElementById('pay-btn');
    const btnConfirm = document.getElementById('confirm-btn');
    const installmentsEl = document.getElementById('installments');
    const amountEl = document.getElementById('amount');

    // cupom
    const couponInput = document.getElementById('coupon');
    const couponPercentInput = document.getElementById('coupon_percent');
    const couponBtn = document.getElementById('apply-coupon');
    const couponStatus = document.getElementById('coupon-status');

    let lastOrderId = null;
    let discountPercent = 0;      // % aplicado
    let baseAmountForDiscount;    // valor base antes do desconto (em R$)

    // ===== utils =====
    const brl = (n)=> (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    function parseAmountBRL(v){ return String(v||'').replace(/[^\d,.\s]/g,'').replace(/\s+/g,'').replace(',','.'); }

    function getAmountNumber(){
      const v = parseFloat(parseAmountBRL(amountEl.value));
      return Number.isFinite(v) ? v : 0;
    }
    function setAmountNumber(n){
      amountEl.value = Number(n||0).toFixed(2).replace('.',',');
    }

    // ===== PREFILL seguro (cart_id / total_cents) e lock do valor =====
    (function securePrefillFromCart(){
      const qs = new URLSearchParams(location.search);
      const cartId = qs.get('cart_id') || '';
      const totalRaw = qs.get('total_cents');
      const totalCents = totalRaw !== null ? parseInt(totalRaw,10) : NaN;

      const cartHidden  = document.getElementById('cart_id');
      const totalHidden = document.getElementById('total_cents');

      if (cartHidden && cartId) cartHidden.value = cartId;
      if (totalHidden && !Number.isNaN(totalCents)) totalHidden.value = String(totalCents);

      if (!Number.isNaN(totalCents)) {
        setAmountNumber(totalCents/100);
        amountEl.readOnly = true;
        amountEl.classList.add('bg-gray-50');
        amountEl.title = 'Valor definido pelo carrinho da loja';
      }

      // define base para desconto (se vier travado, usa o travado)
      baseAmountForDiscount = getAmountNumber();

      form.addEventListener('submit', function(){
        if (cartHidden && !cartHidden.value) cartHidden.value = cartId || '';
        if (totalHidden && !totalHidden.value && !Number.isNaN(totalCents)) totalHidden.value = String(totalCents);
      });
    })();

    // ===== CUPOM: aplicar % e recalcular parcelas =====
    function rebuildAmountWithDiscount() {
      const base = baseAmountForDiscount ?? getAmountNumber();
      const pct  = Math.max(0, Math.min(100, Number(couponPercentInput.value || discountPercent || 0)));
      const final = base * (1 - pct/100);
      setAmountNumber(final);
      buildInstallments();
    }

    couponBtn.addEventListener('click', ()=>{
      const pct = Number(couponPercentInput.value);
      if (!Number.isFinite(pct) || pct < 0 || pct > 100) {
        couponStatus.textContent = '❌ Informe um percentual entre 0 e 100.';
        couponStatus.classList.add('text-red-600');
        couponStatus.classList.remove('text-green-600');
        return;
      }
      discountPercent = pct;
      // fixa a base (se o usuário mexeu manualmente, usa o valor atual como base)
      baseAmountForDiscount = getAmountNumber();
      rebuildAmountWithDiscount();

      const code = (couponInput.value || '').trim().toUpperCase();
      couponStatus.textContent = `✅ Cupom ${code || '(sem código)'} aplicado: ${pct}% OFF`;
      couponStatus.classList.remove('text-red-600');
      couponStatus.classList.add('text-green-600');
    });

    // ===== parcelas =====
    function buildInstallments(){
      if (!installmentsEl) return;
      const total = getAmountNumber();
      let html = '';
      for (let n = 1; n <= 12; n++){
        const per = total / n;
        if (n === 1){
          html += `<option value="1">1x de ${brl(total)} à vista</option>`;
        } else {
          html += `<option value="${n}">${n}x de ${brl(per)} *</option>`;
        }
      }
      installmentsEl.innerHTML = html;
    }
    buildInstallments();
    if (!amountEl.readOnly){
      amountEl.addEventListener('input', ()=>{
        baseAmountForDiscount = getAmountNumber();
        buildInstallments();
      });
    }

    // ===== render helpers =====
    async function copy(text){ try{ await navigator.clipboard.writeText(text); alert('Copiado!'); }catch{ alert('Não foi possível copiar.'); } }
    function renderPix(pix){
      let html = '<div class="p-3 border rounded"><div class="font-semibold mb-1">Pix gerado:</div>';
      if (pix.qr_code_base64) html += `<img class="mx-auto" alt="QR Pix" src="data:image/png;base64,${pix.qr_code_base64}" />`;
      if (pix.qr_code_url) html += `<div class="mt-2"><a class="text-blue-600 underline" target="_blank" rel="noopener noreferrer" href="${pix.qr_code_url}">Abrir QR Code</a></div>`;
      if (pix.qr_code){
        const copyStr = JSON.stringify(pix.qr_code);
        html += `<div class="mt-2 break-all"><strong>Copia & Cola:</strong><br>${pix.qr_code}
          <button type="button" class="ml-2 text-xs px-2 py-1 border rounded" onclick='copy(${copyStr})'>Copiar</button></div>`;
      }
      html += '</div>'; return html;
    }
    function renderBoleto(b){
      let html = '<div class="p-3 border rounded"><div class="font-semibold mb-1">Boleto gerado</div>';
      if (b.url) html += `<div><a class="text-blue-600 underline" target="_blank" rel="noopener noreferrer" href="${b.url}">Abrir boleto (PDF)</a></div>`;
      if (b.line){
        const copyStr = JSON.stringify(b.line);
        html += `<div class="mt-2 break-all"><strong>Linha digitável:</strong><br>${b.line}
          <button type="button" class="ml-2 text-xs px-2 py-1 border rounded" onclick='copy(${copyStr})'>Copiar</button></div>`;
      }
      html += '</div>'; return html;
    }
    function renderCard(c){
      const { status, reason, acquirer_message, code } = c;
      const det = reason || acquirer_message || code;
      return `<div class="p-3 border rounded"><strong>Status do cartão:</strong> ${status || 'desconhecido'}
        ${det ? `<div class="mt-1 text-xs text-gray-600">Detalhe: ${det}</div>` : ''}</div>`;
    }

    // ===== máscaras leves =====
    const cpfEl = document.getElementById('cpf');
    cpfEl.addEventListener('input', ()=>{
      let v = cpfEl.value.replace(/\D/g,'').slice(0,11);
      v = v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');
      cpfEl.value = v;
    });
    const phoneEl = document.getElementById('phone');
    phoneEl.addEventListener('input', ()=>{
      let v = phoneEl.value.replace(/\D/g,'').slice(0,11);
      if (v.length>10) v=v.replace(/(\d{2})(\d{5})(\d{4})/,'$1 $2-$3');
      else v=v.replace(/(\d{2})(\d{4})(\d{0,4})/,'$1 $2-$3');
      phoneEl.value = v.trim();
    });
    const cardEl = document.getElementById('card_number');
    if (cardEl) cardEl.addEventListener('input', ()=>{
      let v = cardEl.value.replace(/\D/g,'').slice(0,16);
      v = v.replace(/(\d{4})(?=\d)/g,'$1 ');
      cardEl.value = v;
    });

    // ===== CEP máscara + autofill ViaCEP =====
    const cepEl = document.getElementById('cep');
    const cepInfo = document.getElementById('cep-info');
    let cepLoading = false;

    cepEl.addEventListener('input', ()=>{
      let v = cepEl.value.replace(/\D/g,'').slice(0,8);
      if (v.length>5) v=v.replace(/(\d{5})(\d{0,3})/,'$1-$2');
      cepEl.value = v;
      if (v.replace(/\D/g,'').length === 8) fillAddressFromCep(v);
    });
    cepEl.addEventListener('blur', () => fillAddressFromCep(cepEl.value));

    async function fillAddressFromCep(cepRaw) {
      const cep = String(cepRaw || '').replace(/\D/g, '');
      if (cep.length !== 8 || cepLoading) return;
      cepLoading = true;
      try {
        cepInfo.textContent = '🔎 Buscando endereço...';
        const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await resp.json();
        if (data?.erro) {
          cepInfo.textContent = '❌ CEP não encontrado';
          return;
        }
        document.getElementById("address1").value     = data.logradouro || "";
        document.getElementById("neighborhood").value = data.bairro || "";
        document.getElementById("city").value         = data.localidade || "";
        document.getElementById("state").value        = (data.uf || "").toUpperCase();
        cepInfo.textContent = `✅ ${data.localidade} / ${data.uf}`;
      } catch (e) {
        cepInfo.textContent = '⚠️ Erro ao buscar CEP';
      } finally {
        cepLoading = false;
      }
    }

    // alterna campos de cartão
    document.querySelectorAll('input[name="pmethod"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const m = document.querySelector('input[name="pmethod"]:checked').value;
        cardBox.classList.toggle('hidden', m !== 'card');
      });
    });

    // ===== submit /pay =====
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (cepLoading) { statusEl.textContent = '⏳ Aguarde terminar a busca do CEP...'; return; }

      statusEl.textContent = 'Processando...';
      extraEl.innerHTML = '';
      btnPay.disabled = true; btnConfirm.disabled = true;
      btnPay.classList.add("opacity-60","cursor-not-allowed");
      btnConfirm.classList.add("cursor-not-allowed","bg-gray-200","text-gray-600");
      lastOrderId = null;

      const payload = {
        name:  document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        cpf:   document.getElementById('cpf').value.replace(/\D/g,''),
        phone: document.getElementById('phone').value.replace(/\D/g,''),
        method: document.querySelector('input[name="pmethod"]:checked').value,
        amountBRL: parseAmountBRL(amountEl.value),

        cart_id: document.getElementById('cart_id').value || null,
        total_cents: document.getElementById('total_cents').value || null,

        // cupom
        coupon: (couponInput.value || '').trim().toUpperCase() || null,
        discount_percent: Number(discountPercent || couponPercentInput.value || 0),

        card_number: (document.getElementById('card_number')?.value || '').replace(/\D/g,''),
        exp_month: Number(document.getElementById('exp_month')?.value || 0),
        exp_year:  Number(document.getElementById('exp_year')?.value || 0),
        cvv:       (document.getElementById('cvv')?.value || '').replace(/\D/g,''),
        installments: Number(document.getElementById('installments')?.value || 1),

        address: {
          cep: document.getElementById('cep').value.replace(/\D/g,''),
          address1: document.getElementById('address1').value.trim(),
          number: document.getElementById('number').value.trim(),
          complement: document.getElementById('complement').value.trim(),
          neighborhood: document.getElementById('neighborhood').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim().toUpperCase()
        }
      };

      try{
        const res = await fetch('/pay',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const result = await res.json();

        statusEl.textContent = res.ok ? '✅ Pedido criado!' : '❌ ' + (result.error || 'Falha');

        if (result?.data?.order_id) lastOrderId = result.data.order_id;

        if (result.pix)    extraEl.innerHTML += renderPix(result.pix);
        if (result.boleto) extraEl.innerHTML += renderBoleto(result.boleto);
        if (result.card)   extraEl.innerHTML += renderCard(result.card);

        // habilita "Já paguei" quando for PIX/BOLETO (confirma manual)
        const m = payload.method;
        if (res.ok && lastOrderId && (m==='pix' || m==='boleto')){
          btnConfirm.disabled = false;
          btnConfirm.classList.remove("cursor-not-allowed","bg-gray-200","text-gray-600");
          btnConfirm.classList.add("bg-white","border","hover:bg-gray-50");
        }
        console.log('Resposta completa:', result);
      }catch(err){
        statusEl.textContent = '❌ Erro de conexão com o servidor.';
        console.error(err);
      }finally{
        btnPay.disabled = false;
        btnPay.classList.remove("opacity-60","cursor-not-allowed");
      }
    });

    // ===== botão "Já paguei" -> POST /confirm =====
    btnConfirm.addEventListener('click', async ()=>{
      if (!lastOrderId) return;
      btnConfirm.disabled = true;
      btnConfirm.textContent = 'Checando...';
      try{
        const r = await fetch('/confirm',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order_id: lastOrderId }) });
        const j = await r.json();
        if (j.ok && j.paid){
          statusEl.textContent = '✅ Pagamento confirmado! Pedido criado na loja.';
        }else{
          statusEl.textContent = '⏳ Ainda não consta como pago. Tente novamente em alguns segundos.';
        }
      }catch(e){
        statusEl.textContent = '❌ Falha ao confirmar pagamento.';
      }finally{
        btnConfirm.disabled = false;
        btnConfirm.textContent = 'Já paguei';
      }
    });

    // Prefill extra
    (function prefillFromQS(){
      const p = new URLSearchParams(location.search);
      if (p.has('name'))  document.getElementById('name').value = p.get('name');
      if (p.has('email')) document.getElementById('email').value = p.get('email');
      if (p.has('cpf'))   document.getElementById('cpf').value = p.get('cpf');
      if (p.has('phone')) document.getElementById('phone').value = p.get('phone');
      if (p.has('amount')){ if(!amountEl.readOnly) amountEl.value=p.get('amount'); }
      if (p.has('method')){
        const m = p.get('method');
        const radio = document.querySelector(`input[name="pmethod"][value="${m}"]`);
        if (radio){ radio.checked = true; cardBox.classList.toggle('hidden', m!=='card'); }
      }
    })();
  </script>
</body>
</html>
