<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pague Leve — Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Meta Pixel (750766562712140) -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','750766562712140'); fbq('track','PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=750766562712140&ev=PageView&noscript=1"/>
  </noscript>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="w-full bg-amber-400 text-black">
    <div class="max-w-md md:max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="logo-pagueleve.png" alt="Pague Leve" class="h-6">
      </div>
      <div class="flex items-center gap-2 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 8V7a3 3 0 016 0v3H9z"/></svg>
        <span>Pagamento 100% seguro</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-[1fr_380px] gap-6 items-start">
      <!-- FORM (esquerda) -->
      ... <!-- (mantém o formulário igual ao seu) -->

      <!-- RESUMO (direita) -->
      <aside class="md:sticky md:top-4">
        <section id="order-summary" class="bg-white p-5 rounded shadow-md hidden">
          <h3 class="text-base font-semibold mb-3">Resumo</h3>
          <div id="order-items" class="space-y-3"></div>

          <div class="mt-3 border-t pt-3 space-y-1 text-sm">
            <div class="flex justify-between"><span>Produtos</span><span id="sum-subtotal">—</span></div>
            <div class="flex justify-between"><span>Frete</span><span>R$ 0,00</span></div>
            <div class="flex justify-between font-semibold text-base">
              <span>Total</span><span id="sum-total">—</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              Para alterar a quantidade, volte ao carrinho.
            </p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <!-- Scripts -->
  <script>
    // =====================================================
    // Resumo lateral (itens) — bloco único atualizado
    // =====================================================
    function brlFmt(cents){
      return (Number(cents||0)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }

    function b64urlToJson(b64url){
      if (!b64url) return [];
      const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
      const pad = '='.repeat((4 - (b64.length % 4)) % 4);
      const str = atob(b64 + pad);
      try { return JSON.parse(decodeURIComponent(escape(str))); }
      catch { return JSON.parse(str); }
    }

    function parseItemsFromQS(){
      const p = new URLSearchParams(location.search);
      const b64 = p.get('items_b64');
      if (b64) return b64urlToJson(b64);
      const raw = p.get('items');
      if (raw){ try { return JSON.parse(decodeURIComponent(raw)); } catch { return []; } }
      return [];
    }

    function renderOrderSummary(){
      const items = parseItemsFromQS();
      const box   = document.getElementById('order-summary');
      const wrap  = document.getElementById('order-items');
      if (!box || !wrap) return;

      if (!items.length){ box.classList.add('hidden'); return; }

      let subtotal = 0;
      wrap.innerHTML = items.map((it)=>{
        const img = it.image
          ? `<img src="${it.image}" class="w-14 h-14 rounded object-cover" alt="">`
          : `<div class="w-14 h-14 rounded bg-gray-100"></div>`;
        const title   = it.title || 'Produto';
        const variant = (it.variant_title || it.variant)
          ? `<div class="text-xs text-gray-500 truncate">Var.: ${it.variant_title || it.variant}</div>` : '';
        const qty     = Math.max(1, Number(it.quantity ?? it.qty ?? 1));
        const price   = Math.max(0, Number(it.price_cents || 0));
        const line    = Number(it.line_price_cents ?? (price * qty));
        subtotal += line;

        return `
          <div class="flex items-center gap-3">
            ${img}
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">${title}</div>
              ${variant}
              <div class="text-xs text-gray-500 mt-1">${brlFmt(price)} un.</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="w-7 h-7 border rounded pointer-events-none opacity-60">–</button>
              <input value="${qty}" class="w-10 h-7 text-center border rounded pointer-events-none bg-gray-50" />
              <button type="button" class="w-7 h-7 border rounded pointer-events-none opacity-60">+</button>
            </div>
            <div class="w-24 text-right font-medium">${brlFmt(line)}</div>
          </div>
        `;
      }).join('');

      const subEl = document.getElementById('sum-subtotal');
      const totEl = document.getElementById('sum-total');
      if (subEl) subEl.textContent = brlFmt(subtotal);

      const enforcedTotal = (Number(document.getElementById('total_cents')?.value || 0) || 0);
      if (totEl) totEl.textContent = brlFmt(enforcedTotal || subtotal);

      box.classList.remove('hidden');
    }

    (function hookTotals(){
      const orig = window.setTotalCents;
      window.setTotalCents = function(cents){
        if (typeof orig === 'function') orig(cents);
        const el = document.getElementById('sum-total');
        if (el) el.textContent = brlFmt(Number(cents||0));
      };
    })();

    // expõe global p/ Console
    window.renderOrderSummary = renderOrderSummary;

    // chama uma vez ao carregar
    renderOrderSummary();
  </script>
</body>
</html>
